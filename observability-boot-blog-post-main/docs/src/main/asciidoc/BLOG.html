<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>How Does Micrometer Observation Work?</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
/*! Asciidoctor Tabs | Copyright (c) 2018-present Dan Allen | MIT License */
.tabs {
    margin-bottom: 1.25em;
}

.tablist > ul {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
    margin: 0;
    padding: 0;
}

.tablist > ul li {
    align-items: center;
    background-color: #fff;
    cursor: pointer;
    display: flex;
    font-weight: bold;
    line-height: 1.5;
    padding: 0.25em 1em;
    position: relative;
}

.tablist > ul li:focus-visible {
    outline: none;
}

.tablist.ulist,
.tablist.ulist > ul li {
    margin: 0;
}

.tablist.ulist > ul li + li {
    margin-left: 0.25em;
}

.tabs .tablist li::after {
    content: "";
    display: block;
    height: 1px;
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
}

.tabs.is-loading .tablist li:not(:first-child),
.tabs:not(.is-loading) .tablist li:not(.is-selected) {
    background-color: #f5f5f5;
}

.tabs.is-loading .tablist li:first-child::after,
.tabs:not(.is-loading) .tablist li.is-selected::after {
    background-color: #fff;
}

/*
.tabs:not(.is-loading) .tablist li,
.tabs:not(.is-loading) .tablist li::after {
  transition: background-color 200ms ease-in-out;
}
*/

.tablist > ul p {
    line-height: inherit;
    margin: 0;
}

.tabpanel {
    background-color: #fff;
    padding: 1.25em;
}

.tablist > ul li,
.tabpanel {
    border: 1px solid #dcdcdc;
}

.tablist > ul li {
    border-bottom: 0;
}

.tabs.is-loading .tabpanel + .tabpanel,
.tabs:not(.is-loading) .tabpanel.is-hidden {
    display: none;
}

.tabpanel > :first-child {
    margin-top: 0;
}

/* #content is a signature of the Asciidoctor standalone HTML output */
#content .tabpanel > :last-child,
#content .tabpanel > :last-child > :last-child,
#content .tabpanel > :last-child > :last-child > li:last-child > :last-child {
    margin-bottom: 0;
}

.tablecontainer {
    overflow-x: auto;
}

#content .tablecontainer {
    margin-bottom: 1.25em;
}

#content .tablecontainer > table.tableblock {
    margin-bottom: 0;
}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="paragraph">
<p>The Spring Observability Team has been working on adding observability support for Spring Applications for quite some time, and we are pleased to inform you that this feature will be generally available with Spring Framework 6 and Spring Boot 3!</p>
</div>
<div class="paragraph">
<p>What is observability? In our understanding, it is <em>"how well you can understand the internals of your system by examining its outputs"</em>. We believe that the interconnection between metrics, logging, and distributed tracing gives you the ability to reason about the state of your system in order to debug exceptions and latency in your applications. You can watch more about what we think observability is in <a href="https://tanzu.vmware.com/developer/tv/enlightning/10/">this episode of Enlightning with Jonatan Ivanov</a>.</p>
</div>
<div class="paragraph">
<p>The upcoming Spring Boot <code>3.0.0-RC1</code> release will contain numerous autoconfigurations for improved metrics with <a href="https://micrometer.io/">Micrometer</a> and new distributed tracing support with <a href="https://micrometer.io/docs/tracing">Micrometer Tracing</a> (formerly <a href="https://spring.io/projects/spring-cloud-sleuth">Spring Cloud Sleuth</a>). The most notable changes are that it will contain built-in support for log correlation, <a href="https://www.w3.org/TR/trace-context/">W3C context propagation</a> will be the default propagation type, and we will support automatic propagation of metadata to be used by the tracing infrastructure (called "remote baggage") that helps to label the observations.</p>
</div>
<div class="paragraph">
<p>We have been changing the Micrometer API a lot over the course of this year. The most important change is that we have introduced a new API: the Observation API.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The idea of its founding was that we want the users to instrument their code once using a single API and have multiple benefits out of it (e.g. metrics, tracing, logging).</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This blog post details what you need to know to about that API and how you can use it to provide more insights into your application.</p>
</div>
<h1 id="_how_does_micrometer_observation_work" class="sect0">How Does Micrometer Observation Work?</h1>
<div class="paragraph">
<p>For any observation to happen, you need to register <code>ObservationHandler</code> objects through an <code>ObservationRegistry</code>. An <code>ObservationHandler</code> reacts only to supported implementations of an <code>Observation.Context</code> and can create, for example, timers, spans, and logs by reacting to the lifecycle events of an observation, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>start</code> - Observation has been started. Happens when the <code>Observation#start()</code> method gets called.</p>
</li>
<li>
<p><code>stop</code> - Observation has been stopped. Happens when the <code>Observation#stop()</code> method gets called.</p>
</li>
<li>
<p><code>error</code> - An error occurred while observing. Happens when the <code>Observation#error(exception)</code> method gets called.</p>
</li>
<li>
<p><code>event</code> - An event happened when observing. Happens when the <code>Observation#event(event)</code> method gets called.</p>
</li>
<li>
<p><code>scope started</code> - Observation opens a scope. The scope must be closed when no longer used. Handlers can create thread local variables on start that are cleared upon closing of the scope. Happens when the <code>Observation#openScope()</code> method gets called.</p>
</li>
<li>
<p><code>scope stopped</code> - Observation stops a scope. Happens when the <code>Observation.Scope#close()</code> method gets called.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Whenever any of these methods is called, an <code>ObservationHandler</code> method (such as <code>onStart(T extends Observation.Context ctx)</code>, <code>onStop(T extends Observation.Context ctx)</code>, and so on) are called. To pass state between the handler methods, you can use the <code>Observation.Context</code>.</p>
</div>
<div class="paragraph">
<p>The observation state diagram looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>        Observation           Observation
        Context               Context
Created ----------&gt; Started ----------&gt; Stopped</code></pre>
</div>
</div>
<div class="paragraph">
<p>The observation Scope state diagram looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>              Observation
              Context
Scope Started ----------&gt; Scope Closed</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make it possible to debug production problems, an observation needs additional metadata, such as key-value pairs (also known as tags). You can then query your metrics or distributed tracing backend by using those tags to find the required data. Tags can be of either high or low cardinality.</p>
</div>
<div class="paragraph">
<p>This is an example of the Micrometer Observation API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// Create an ObservationRegistry</span>
ObservationRegistry registry = ObservationRegistry.create();
<span style="color:#777">// Register an ObservationHandler</span>
registry.observationConfig().observationHandler(<span style="color:#080;font-weight:bold">new</span> MyHandler());

<span style="color:#777">// Create an Observation and observe your code!</span>
Observation.createNotStarted(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">user.name</span><span style="color:#710">&quot;</span></span>, registry)
        .contextualName(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">getting-user-name</span><span style="color:#710">&quot;</span></span>)
        .lowCardinalityKeyValue(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userType</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userType1</span><span style="color:#710">&quot;</span></span>) <span style="color:#777">// let's assume that you can have 3 user types</span>
        .highCardinalityKeyValue(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userId</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">1234</span><span style="color:#710">&quot;</span></span>) <span style="color:#777">// let's assume that this is an arbitrary number</span>
        .observe(() -&gt; log.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Hello</span><span style="color:#710">&quot;</span></span>)); <span style="color:#777">// this is a shortcut for starting an observation, opening a scope, running user's code, closing the scope and stopping the observation</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<strong>High cardinality</strong> means that a pair will have an unbounded number of possible values. An HTTP URL is a good
example of such a key value (for example, <code>/user/user1234</code>, <code>/user/user2345</code>, and so on). <strong>Low cardinality</strong> means that a key value will  have a bounded number of possible values. A <strong>templated</strong> HTTP URL (such as <code>/user/{userId}</code>) is a good example of such a key value.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To separate observation lifecycle operations from an observation configuration (such as names and low and high cardinality tags), you can use the <code>ObservationConvention</code> that provides an easy way of overriding the default naming conventions.</p>
</div>
<h1 id="_building_your_first_observed_application" class="sect0">Building Your First Observed Application</h1>
<div class="paragraph">
<p>The easiest way to get started is to create a new project from <a href="https://start.spring.io" class="bare">https://start.spring.io</a>. Make sure to select Spring Boot 3.0.0-SNAPSHOT (you can switch to RC1 once <a href="https://calendar.spring.io/">it&#8217;s available</a>) and your favorite build tool.</p>
</div>
<div class="paragraph">
<p>We will build a Spring WebMvc server application and a client to call the server using RestTemplate. We start with the server side.</p>
</div>
<div class="sect1">
<h2 id="_webmvc_server_setup">WebMvc Server Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since we want to start an HTTP server, we have to pick the <code>org.springframework.boot:spring-boot-starter-web</code> dependency.</p>
</div>
<div class="paragraph">
<p>To create observations by using the <code>@Observed</code> aspect, we need to add the <code>org.springframework.boot:spring-boot-starter-aop</code> dependency.</p>
</div>
<div class="paragraph">
<p>To add observation features to your application, choose <code>spring-boot-starter-actuator</code> (to add <a href="https://micrometer.io">Micrometer</a> to the classpath).</p>
</div>
<div class="paragraph">
<p>Now it is time to add observability related features!</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Metrics</strong></p>
<div class="ulist">
<ul>
<li>
<p>For Micrometer metrics with Prometheus, we need to add the <code>io.micrometer:micrometer-registry-prometheus</code> dependency.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Tracing</strong></p>
<div class="ulist">
<ul>
<li>
<p>For <strong>Tracing Context Propagation</strong> with Micrometer Tracing, we need to pick a <strong>tracer</strong> bridge (<strong>tracer</strong> is a library that is used to handle the lifecycle of a span). We pick <a href="https://zipkin.io">Zipkin Brave</a> by adding the <code>io.micrometer:micrometer-tracing-bridge-brave</code>.</p>
<div class="ulist">
<ul>
<li>
<p>The client application that we will create for this demo will use another tracer library to show an interop between tracers.</p>
</li>
</ul>
</div>
</li>
<li>
<p>For <strong>Latency Visualization</strong>, we need to send the finished spans in some format to a server. In our case, we produce an Zipkin-compliant span. To achieve that, we need to add the <code>io.zipkin.reporter2:zipkin-reporter-brave</code> dependency.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Logs</strong></p>
<div class="ulist">
<ul>
<li>
<p>Since we have Micrometer Tracing on the classpath, the logs are automatically correlated (that is, they contain a unique trace identifier). Now we need to ship the logs. For this demo, we ship them to <a href="https://grafana.com/oss/loki/">Grafana Loki</a>. We can achieve that by adding the <code>com.github.loki4j:loki-logback-appender</code> dependency (check <a href="https://search.maven.org/artifact/com.github.loki4j/loki-logback-appender">this link</a> for the latest release version)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you are new to tracing, we need to quickly define a couple of basic terms. You can wrap any operation in a <code>span</code>. It has a unique <code>span id</code> and contains timing information and some additional metadata (key-value pairs). Because you can produce child spans from spans, the whole tree of spans forms a <code>trace</code> that shares the same <code>trace id</code> (that is, a correlation identifier).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we need to add some configuration. We set up <code>actuator</code> and <code>metrics</code> to publish percentiles histograms, and we redefine the logging pattern to include the trace and span identifiers. We set the sampling probability to <code>1.0</code> to send all traces to latency analysis tool.</p>
</div>
<div class="listingblock">
<div class="title">/src/main/resources/application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">server.port=7654
spring.application.name=server

# All traces should be sent to latency analysis tool
management.tracing.sampling.probability=1.0
management.endpoints.web.exposure.include=prometheus

# For Exemplars to work we need histogram buckets
management.metrics.distribution.percentiles-histogram.http.server.requests=true

# traceID and spanId are predefined MDC keys - we want the logs to include them
logging.pattern.level=%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we are running the <a href="https://grafana.com/grafana/">Grafana</a> stack with <a href="https://grafana.com/oss/loki/">Loki</a> and <a href="https://grafana.com/oss/tempo/">Tempo</a> locally, we configure the <code>loki-logback-appender</code> to send logs to the local instance of Loki.</p>
</div>
<div class="listingblock">
<div class="title">/src/main/resources/logback-spring.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#579">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span style="color:#070;font-weight:bold">&lt;configuration&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;include</span> <span style="color:#b48">resource</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org/springframework/boot/logging/logback/base.xml</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;springProperty</span> <span style="color:#b48">scope</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">context</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">appName</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">source</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">spring.application.name</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>

    <span style="color:#070;font-weight:bold">&lt;appender</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LOKI</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">com.github.loki4j.logback.Loki4jAppender</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;http&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;url&gt;</span>http://localhost:3100/loki/api/v1/push<span style="color:#070;font-weight:bold">&lt;/url&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;/http&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;format&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;label&gt;</span>
                <span style="color:#070;font-weight:bold">&lt;pattern&gt;</span>app=${appName},host=${HOSTNAME},traceID=%X{traceId:-NONE},level=%level<span style="color:#070;font-weight:bold">&lt;/pattern&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;/label&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;message&gt;</span>
                <span style="color:#070;font-weight:bold">&lt;pattern&gt;</span>${FILE_LOG_PATTERN}<span style="color:#070;font-weight:bold">&lt;/pattern&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;/message&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;sortByTime&gt;</span>true<span style="color:#070;font-weight:bold">&lt;/sortByTime&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;/format&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/appender&gt;</span>

    <span style="color:#070;font-weight:bold">&lt;root</span> <span style="color:#b48">level</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">INFO</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;appender-ref</span> <span style="color:#b48">ref</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LOKI</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/root&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/configuration&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_webmvc_server_code">WebMvc Server Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Time to write some server-side code! We want to achieve full observability of our application, including metrics, tracing, and additional logging.</p>
</div>
<div class="paragraph">
<p>To begin with, we write a controller that logs a message to the console and delegate work to a service.</p>
</div>
<div class="listingblock">
<div class="title">MyController.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@RestController</span>
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyController</span> {

        <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Logger</span> log = LoggerFactory.getLogger(MyController.class);
        <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> MyUserService myUserService;

        MyController(MyUserService myUserService) {
                <span style="color:#950">this</span>.myUserService = myUserService;
        }

        <span style="color:#007">@GetMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/user/{userId}</span><span style="color:#710">&quot;</span></span>)
        <span style="color:#0a8;font-weight:bold">String</span> userName(<span style="color:#007">@PathVariable</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userId</span><span style="color:#710">&quot;</span></span>) <span style="color:#0a8;font-weight:bold">String</span> userId) {
                log.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Got a request</span><span style="color:#710">&quot;</span></span>);
                <span style="color:#080;font-weight:bold">return</span> myUserService.userName(userId);
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to have some detailed observation of the <code>MyUserService#userName</code> method. Thanks to having added AOP support, we can use the <code>@Observed</code> annotation. To do so, we can register a <code>ObservedAspect</code> bean.</p>
</div>
<div class="listingblock">
<div class="title">MyConfiguration.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Configuration</span>(proxyBeanMethods = <span style="color:#069">false</span>)
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyConfiguration</span> {
        <span style="color:#777">// To have the @Observed support we need to register this aspect</span>
        <span style="color:#007">@Bean</span>
        ObservedAspect observedAspect(ObservationRegistry observationRegistry) {
                <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> ObservedAspect(observationRegistry);
        }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">MyUserService.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Service</span>
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyUserService</span> {

        <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Logger</span> log = LoggerFactory.getLogger(MyUserService.class);

        <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Random</span> random = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">Random</span>();

        <span style="color:#777">// Example of using an annotation to observe methods</span>
        <span style="color:#777">// &lt;user.name&gt; will be used as a metric name</span>
        <span style="color:#777">// &lt;getting-user-name&gt; will be used as a span  name</span>
        <span style="color:#777">// &lt;userType=userType2&gt; will be set as a tag for both metric &amp; span</span>
        <span style="color:#007">@Observed</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">user.name</span><span style="color:#710">&quot;</span></span>,
                        contextualName = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">getting-user-name</span><span style="color:#710">&quot;</span></span>,
                        lowCardinalityKeyValues = {<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userType</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userType2</span><span style="color:#710">&quot;</span></span>})
        <span style="color:#0a8;font-weight:bold">String</span> userName(<span style="color:#0a8;font-weight:bold">String</span> userId) {
                log.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Getting user name for user with id &lt;{}&gt;</span><span style="color:#710">&quot;</span></span>, userId);
                <span style="color:#080;font-weight:bold">try</span> {
                        <span style="color:#0a8;font-weight:bold">Thread</span>.sleep(random.nextLong(<span style="color:#00D">200L</span>)); <span style="color:#777">// simulates latency</span>
                }
                <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#C00;font-weight:bold">InterruptedException</span> e) {
                        <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">RuntimeException</span>(e);
                }
                <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">foo</span><span style="color:#710">&quot;</span></span>;
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With metrics and tracing on the classpath, having this annotation leads to the creation of a <code>timer</code>, a <code>long task timer</code>, and a <code>span</code>. The timer would be named <code>user.name</code>, the long task timer would be named <code>user.name.active</code>, and the span would be named <code>getting-user-name</code>.</p>
</div>
<div class="paragraph">
<p>What about logs? We do not want to write the logging statements manually whenever an observation takes place. What we can do is to create a dedicated handler that logs some text for each observation.</p>
</div>
<div class="listingblock">
<div class="title">MyHandler.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// Example of plugging in a custom handler that in this case will print a statement before and after all observations take place</span>
<span style="color:#007">@Component</span>
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyHandler</span> <span style="color:#088;font-weight:bold">implements</span> ObservationHandler&lt;Observation.Context&gt; {

        <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Logger</span> log = LoggerFactory.getLogger(MyHandler.class);

        <span style="color:#007">@Override</span>
        <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> onStart(Observation.Context context) {
                log.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Before running the observation for context [{}], userType [{}]</span><span style="color:#710">&quot;</span></span>, context.getName(), getUserTypeFromContext(context));
        }

        <span style="color:#007">@Override</span>
        <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> onStop(Observation.Context context) {
                log.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">After running the observation for context [{}], userType [{}]</span><span style="color:#710">&quot;</span></span>, context.getName(), getUserTypeFromContext(context));
        }

        <span style="color:#007">@Override</span>
        <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> supportsContext(Observation.Context context) {
                <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">true</span>;
        }

        <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> getUserTypeFromContext(Observation.Context context) {
                <span style="color:#080;font-weight:bold">return</span> StreamSupport.stream(context.getLowCardinalityKeyValues().spliterator(), <span style="color:#069">false</span>)
                                .filter(keyValue -&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userType</span><span style="color:#710">&quot;</span></span>.equals(keyValue.getKey()))
                                .map(KeyValue::getValue)
                                .findFirst()
                                .orElse(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">UNKNOWN</span><span style="color:#710">&quot;</span></span>);
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>That is it! Time for the client side.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resttemplate_client_application_setup">RestTemplate Client Application Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As before, we add the <code>spring-boot-starter-web</code> and <code>spring-boot-starter-actuator</code> dependencies to have a web server running and Micrometer support added.</p>
</div>
<div class="paragraph">
<p>Time to add observability related features!</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Metrics</strong></p>
<div class="ulist">
<ul>
<li>
<p>For Micrometer metrics with Prometheus, we need to add the <code>io.micrometer:micrometer-registry-prometheus</code> dependency.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Tracing</strong></p>
<div class="ulist">
<ul>
<li>
<p>For <strong>Tracing Context Propagation</strong> with Micrometer Tracing, we need to pick a <strong>tracer</strong> bridge. We pick <a href="https://opentelemetry.io">OpenTelemetry</a> by adding the <code>io.micrometer:micrometer-tracing-bridge-otel</code>.</p>
</li>
<li>
<p>For <strong>Latency Visualization</strong>, we need to send the finished spans in some format to a server. In our case, we produce an OpenZipkin compliant span. To achieve that, we need to add the <code>io.opentelemetry:opentelemetry-exporter-zipkin</code> dependency.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Logs</strong></p>
<div class="ulist">
<ul>
<li>
<p>As previously, we add the <code>com.github.loki4j:loki-logback-appender</code> dependency (check <a href="https://search.maven.org/artifact/com.github.loki4j/loki-logback-appender">this link</a> for the latest release version) to ship logs to Loki.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now we need to add some configuration. We add almost identical configuration as we did on the server side.</p>
</div>
<div class="listingblock">
<div class="title">/src/main/resources/application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">server.port=6543
spring.application.name=client

# All traces should be sent to latency analysis tool
management.tracing.sampling.probability=1.0
management.endpoints.web.exposure.include=prometheus

# traceID and spanId are predefined MDC keys - we want the logs to include them
logging.pattern.level=%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Loki Appender configuration looks exactly the same.</p>
</div>
<div class="listingblock">
<div class="title">/src/main/resources/logback-spring.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#579">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span style="color:#070;font-weight:bold">&lt;configuration&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;include</span> <span style="color:#b48">resource</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org/springframework/boot/logging/logback/base.xml</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;springProperty</span> <span style="color:#b48">scope</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">context</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">appName</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">source</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">spring.application.name</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>

    <span style="color:#070;font-weight:bold">&lt;appender</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LOKI</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">com.github.loki4j.logback.Loki4jAppender</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;http&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;url&gt;</span>http://localhost:3100/loki/api/v1/push<span style="color:#070;font-weight:bold">&lt;/url&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;/http&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;format&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;label&gt;</span>
                <span style="color:#070;font-weight:bold">&lt;pattern&gt;</span>app=${appName},host=${HOSTNAME},traceID=%X{traceId:-NONE},level=%level<span style="color:#070;font-weight:bold">&lt;/pattern&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;/label&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;message&gt;</span>
                <span style="color:#070;font-weight:bold">&lt;pattern&gt;</span>${FILE_LOG_PATTERN}<span style="color:#070;font-weight:bold">&lt;/pattern&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;/message&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;sortByTime&gt;</span>true<span style="color:#070;font-weight:bold">&lt;/sortByTime&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;/format&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/appender&gt;</span>

    <span style="color:#070;font-weight:bold">&lt;root</span> <span style="color:#b48">level</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">INFO</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;appender-ref</span> <span style="color:#b48">ref</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LOKI</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/root&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/configuration&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resttemplate_application_client_code">RestTemplate Application Client Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now it is time to write some client-side code! We send a request with <code>RestTemplate</code> to the server side, and we want to achieve the full observability of our application, including metrics and tracing.</p>
</div>
<div class="paragraph">
<p>To begin, we need a <code>RestTemplate</code> bean that is automatically instrumented by Spring Boot. Remember to inject the <code>RestTemplateBuilder</code> and to construct a <code>RestTemplate</code> instance from the builder.</p>
</div>
<div class="listingblock">
<div class="title">MyConfiguration.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Configuration</span>(proxyBeanMethods = <span style="color:#069">false</span>)
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyConfiguration</span> {
        <span style="color:#777">// IMPORTANT! To instrument RestTemplate you must inject the RestTemplateBuilder</span>
        <span style="color:#007">@Bean</span>
        RestTemplate restTemplate(RestTemplateBuilder builder) {
                <span style="color:#080;font-weight:bold">return</span> builder.build();
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can write a <code>CommandLineRunner</code> bean that is wrapped by using the Observation API and that sends a request to the server side. All parts of the API are described in more detail in the following snippet.</p>
</div>
<div class="listingblock">
<div class="title">MyConfiguration.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Configuration</span>(proxyBeanMethods = <span style="color:#069">false</span>)
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyConfiguration</span> {
        <span style="color:#007">@Bean</span>
        CommandLineRunner myCommandLineRunner(ObservationRegistry registry, RestTemplate restTemplate) {
                <span style="color:#0a8;font-weight:bold">Random</span> highCardinalityValues = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">Random</span>(); <span style="color:#777">// Simulates potentially large number of values</span>
                <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; lowCardinalityValues = <span style="color:#0a8;font-weight:bold">Arrays</span>.asList(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userType1</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userType2</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userType3</span><span style="color:#710">&quot;</span></span>); <span style="color:#777">// Simulates low number of values</span>
                <span style="color:#080;font-weight:bold">return</span> args -&gt; {
                        <span style="color:#0a8;font-weight:bold">String</span> highCardinalityUserId = <span style="color:#0a8;font-weight:bold">String</span>.valueOf(highCardinalityValues.nextLong(<span style="color:#00D">100</span>_000));
                        <span style="color:#777">// Example of using the Observability API manually</span>
                        <span style="color:#777">// &lt;my.observation&gt; is a &quot;technical&quot; name that does not depend on the context. It will be used to name e.g. Metrics</span>
                         Observation.createNotStarted(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my.observation</span><span style="color:#710">&quot;</span></span>, registry)
                                         <span style="color:#777">// Low cardinality means that the number of potential values won't be big. Low cardinality entries will end up in e.g. Metrics</span>
                                        .lowCardinalityKeyValue(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userType</span><span style="color:#710">&quot;</span></span>, randomUserTypePicker(lowCardinalityValues))
                                         <span style="color:#777">// High cardinality means that the number of potential values can be large. High cardinality entries will end up in e.g. Spans</span>
                                        .highCardinalityKeyValue(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">userId</span><span style="color:#710">&quot;</span></span>, highCardinalityUserId)
                                         <span style="color:#777">// &lt;command-line-runner&gt; is a &quot;contextual&quot; name that gives more details within the provided context. It will be used to name e.g. Spans</span>
                                        .contextualName(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">command-line-runner</span><span style="color:#710">&quot;</span></span>)
                                         <span style="color:#777">// The following lambda will be executed with an observation scope (e.g. all the MDC entries will be populated with tracing information). Also the observation will be started, stopped and if an error occurred it will be recorded on the observation</span>
                                        .observe(() -&gt; {
                                                log.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Will send a request to the server</span><span style="color:#710">&quot;</span></span>); <span style="color:#777">// Since we're in an observation scope - this log line will contain tracing MDC entries ...</span>
                                                <span style="color:#0a8;font-weight:bold">String</span> response = restTemplate.getForObject(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://localhost:7654/user/{userId}</span><span style="color:#710">&quot;</span></span>, <span style="color:#0a8;font-weight:bold">String</span>.class, highCardinalityUserId); <span style="color:#777">// Boot's RestTemplate instrumentation creates a child span here</span>
                                                log.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Got response [{}]</span><span style="color:#710">&quot;</span></span>, response); <span style="color:#777">// ... so will this line</span>
                                        });

                };
        }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_it_all_together">Running It All Together</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have prepared a Docker setup of the whole observability infrastructure under <a href="https://github.com/marcingrzejszczak/observability-boot-blog-post">this link</a>. Follow these steps to run the infrastructure and both applications.</p>
</div>
<div class="sect2">
<h3 id="_running_the_samples">Running the samples</h3>
<div class="paragraph">
<p>To run the samples:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start up the observability stack (for demonstration purposes, you can use the provided Grafana, Tempo, and Loki stack) and wait for it to start.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ docker compose up</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>To access Prometheus go to <a href="http://localhost:9090/" class="bare">http://localhost:9090/</a></p>
</li>
<li>
<p>To access Grafana go to <a href="http://localhost:3000/" class="bare">http://localhost:3000/</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Run the server side application (this will block your current terminal window).</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ ./mvnw spring-boot:run -pl :server</code></pre>
</div>
</div>
</li>
<li>
<p>Run the client side application (this will block your current terminal window)</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ ./mvnw spring-boot:run -pl :client</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see log statements similar to these:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>2022-10-04T15:04:55.345+02:00  INFO [client,bbe3aea006077640b66d40f3e62f04b9,93b7a150b7e293ef] 92556 --- [           main] com.example.client.ClientApplication     : Will send a request to the server
2022-10-04T15:04:55.385+02:00  INFO [client,bbe3aea006077640b66d40f3e62f04b9,93b7a150b7e293ef] 92556 --- [           main] com.example.client.ClientApplication     : Got response [foo]</code></pre>
</div>
</div>
</li>
<li>
<p>Go to <a href="http://localhost:3000/">Grafana</a>, go to dashboards, and click on the <code>Logs, Traces, Metrics</code> dashboard. There you can pick a trace ID value (for example, <code>bbe3aea006077640b66d40f3e62f04b9</code>) to find all logs and traces from both applications that correspond to that trace ID. You should see a following correlated view of logs and traces related to the same trace identifier, and you will see metrics taking place at the same time range. The metrics are related to HTTP request processing latency. These come from the automated Spring Boot WebMvc instrumentation that uses the Micrometer API.</p>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/marcingrzejszczak/observability-boot-blog-post/main/docs/src/main/asciidoc/img/logs-metrics-traces.png" alt="logs metrics traces">
</div>
</div>
<div class="paragraph">
<p>Notice a diamond shape in the metrics. These are <a href="https://grafana.com/docs/grafana/latest/basics/exemplars/"><code>Exemplars</code></a>. Those are &#8220;specific trace representative of measurement taken in a given time interval&#8221;. If you click on the shape, you can jump to the trace ID view to see the corresponding trace.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/marcingrzejszczak/observability-boot-blog-post/main/docs/src/main/asciidoc/img/exemplar.png" alt="exemplar">
</div>
</div>
</li>
<li>
<p>Either click on the trace ID to <code>Query it with Tempo</code> or go to Tempo and pick the trace identifier yourself. You will see the following screen.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/marcingrzejszczak/observability-boot-blog-post/main/docs/src/main/asciidoc/img/trace-view.png" alt="trace view">
</div>
</div>
<div class="paragraph">
<p>Each bar represents a <code>span</code>. You can see how much time it took for each operation to complete. If you click on a given span, you can see tags (key-value metadata) and timing information related to that particular operation.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/marcingrzejszczak/observability-boot-blog-post/main/docs/src/main/asciidoc/img/span-tags.png" alt="span tags">
</div>
</div>
<div class="paragraph">
<p>This is how the correlated logs view would look in Loki.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/marcingrzejszczak/observability-boot-blog-post/main/docs/src/main/asciidoc/img/correlated-logs.png" alt="correlated logs">
</div>
</div>
<div class="paragraph">
<p>If you want to see the <code>@Observed</code> annotated method metrics, you can go to the <code>Prometheus</code> view and find the <code>user_name</code> Timer.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/marcingrzejszczak/observability-boot-blog-post/main/docs/src/main/asciidoc/img/annotation-metric.png" alt="annotation metric">
</div>
</div>
<div class="paragraph">
<p>If you want to see the metrics from your Observation that you have manually created, go to the <code>Prometheus</code> view and find the <code>my_observation</code> Timer.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/marcingrzejszczak/observability-boot-blog-post/main/docs/src/main/asciidoc/img/my-observation.png" alt="my observation">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_it_all_together_with_aot_support">Running It All Together with AOT Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To better understand how Spring Boot supports Native, please read <a href="https://spring.io/blog/2022/09/26/native-support-in-spring-boot-3-0-0-m5">this excellent blog post</a>. We reuse that knowledge to run the previously created applications using Spring Native.</p>
</div>
<div class="sect2">
<h3 id="_building">Building</h3>
<div class="paragraph">
<p>To build the applications, you need GraalVM on your path. If you use <code>SDKMan</code>, invoke the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sdk install java 22.3.r17.ea-nik</pre>
</div>
</div>
<div class="paragraph">
<p>See also <a href="https://www.graalvm.org/java/quickstart/">GraalVM Quickstart</a>.</p>
</div>
<div class="paragraph">
<p>To build the application with Maven, you need to enable the <code>native</code> profile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./mvnw native:compile -Pnative</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running">Running</h3>
<div class="paragraph">
<p>Run the server side application first</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./server/target/server</pre>
</div>
</div>
<div class="paragraph">
<p>Next, run the client side application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./client/target/client</pre>
</div>
</div>
<div class="paragraph">
<p>You should get output similar to this:</p>
</div>
<div class="listingblock">
<div class="title">Client side logs</div>
<div class="content">
<pre>2022-10-10T12:57:17.712+02:00  INFO [client,,] 82009 --- [           main] com.example.client.ClientApplication     : Starting ClientApplication using Java 17.0.4 on marcin-precision5560 with PID 82009 (/home/marcin/repo/observability/blogs/bootRc1/client/target/client started by marcin in /home/marcin/repo/observability/blogs/bootRc1)
2022-10-10T12:57:17.712+02:00  INFO [client,,] 82009 --- [           main] com.example.client.ClientApplication     : No active profile set, falling back to 1 default profile: "default"
2022-10-10T12:57:17.723+02:00  INFO [client,,] 82009 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 6543 (http)
2022-10-10T12:57:17.723+02:00  INFO [client,,] 82009 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2022-10-10T12:57:17.723+02:00  INFO [client,,] 82009 --- [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.0.23]
2022-10-10T12:57:17.727+02:00  INFO [client,,] 82009 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2022-10-10T12:57:17.727+02:00  INFO [client,,] 82009 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 15 ms
2022-10-10T12:57:17.731+02:00  WARN [client,,] 82009 --- [           main] i.m.c.i.binder.jvm.JvmGcMetrics          : GC notifications will not be available because MemoryPoolMXBeans are not provided by the JVM
2022-10-10T12:57:17.781+02:00  INFO [client,,] 82009 --- [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 15 endpoint(s) beneath base path '/actuator'
2022-10-10T12:57:17.783+02:00  INFO [client,,] 82009 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 6543 (http) with context path ''
2022-10-10T12:57:17.783+02:00  INFO [client,,] 82009 --- [           main] com.example.client.ClientApplication     : Started ClientApplication in 0.077 seconds (process running for 0.079)
2022-10-10T12:57:17.784+02:00  INFO [client,27c1113e4276c4173daec3675f536bf4,e0f2db8b983607d8] 82009 --- [           main] com.example.client.ClientApplication     : Will send a request to the server
2022-10-10T12:57:17.820+02:00  INFO [client,27c1113e4276c4173daec3675f536bf4,e0f2db8b983607d8] 82009 --- [           main] com.example.client.ClientApplication     : Got response [foo]
2022-10-10T12:57:18.966+02:00  INFO [client,,] 82009 --- [nio-6543-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-10-10T12:57:18.966+02:00  INFO [client,,] 82009 --- [nio-6543-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2022-10-10T12:57:18.966+02:00  INFO [client,,] 82009 --- [nio-6543-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 0 ms</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server side logs</div>
<div class="content">
<pre>2022-10-10T12:57:07.200+02:00  INFO [server,,] 81760 --- [           main] com.example.server.ServerApplication     : Starting ServerApplication using Java 17.0.4 on marcin-precision5560 with PID 81760 (/home/marcin/repo/observability/blogs/bootRc1/server/target/server started by marcin in /home/marcin/repo/observability/blogs/bootRc1)
2022-10-10T12:57:07.201+02:00  INFO [server,,] 81760 --- [           main] com.example.server.ServerApplication     : No active profile set, falling back to 1 default profile: "default"
2022-10-10T12:57:07.213+02:00  INFO [server,,] 81760 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 7654 (http)
2022-10-10T12:57:07.213+02:00  INFO [server,,] 81760 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2022-10-10T12:57:07.213+02:00  INFO [server,,] 81760 --- [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.0.23]
2022-10-10T12:57:07.217+02:00  INFO [server,,] 81760 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2022-10-10T12:57:07.217+02:00  INFO [server,,] 81760 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 16 ms
2022-10-10T12:57:07.222+02:00  WARN [server,,] 81760 --- [           main] i.m.c.i.binder.jvm.JvmGcMetrics          : GC notifications will not be available because MemoryPoolMXBeans are not provided by the JVM
2022-10-10T12:57:07.278+02:00  INFO [server,,] 81760 --- [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 15 endpoint(s) beneath base path '/actuator'
2022-10-10T12:57:07.280+02:00  INFO [server,,] 81760 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 7654 (http) with context path ''
2022-10-10T12:57:07.281+02:00  INFO [server,,] 81760 --- [           main] com.example.server.ServerApplication     : Started ServerApplication in 0.086 seconds (process running for 0.088)
2022-10-10T12:57:07.639+02:00  INFO [server,,] 81760 --- [nio-7654-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-10-10T12:57:07.639+02:00  INFO [server,,] 81760 --- [nio-7654-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2022-10-10T12:57:07.640+02:00  INFO [server,,] 81760 --- [nio-7654-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 1 ms
2022-10-10T12:57:17.785+02:00  INFO [server,,] 81760 --- [nio-7654-exec-8] com.example.server.MyHandler             : Before running the observation for context [http.server.requests]
2022-10-10T12:57:17.785+02:00  INFO [server,27c1113e4276c4173daec3675f536bf4,9affba5698490e2d] 81760 --- [nio-7654-exec-8] com.example.server.MyController          : Got a request
2022-10-10T12:57:17.820+02:00  INFO [server,,] 81760 --- [nio-7654-exec-8] com.example.server.MyHandler             : After running the observation for context [http.server.requests]</pre>
</div>
</div>
<div class="paragraph">
<p>You can check Grafana for metrics, traces and logs!</p>
</div>
</div>
<div class="sect2">
<h3 id="native-support-limitations">Native Support Limitations</h3>
<div class="paragraph">
<p>On the client side, we need to provide the <code>reflect-config.js</code> configuration manually. For more information, see <a href="https://github.com/open-telemetry/opentelemetry-java/pull/4832">this PR</a>.</p>
</div>
</div>
</div>
</div>
<h1 id="_summary" class="sect0">Summary</h1>
<div class="paragraph">
<p>In this blog post, we have managed to give you an introduction of the main concepts behind the Micrometer Observability API. We have also shown you how you can create observations by using the Observation API and annotations. You can also visualize the latency, see the correlated logs, and check the metrics that come from your Spring Boot applications.</p>
</div>
<div class="paragraph">
<p>You could also observe your applications by using native images with Spring Native.</p>
</div>
<h1 id="_acknowledgments" class="sect0">Acknowledgments</h1>
<div class="paragraph">
<p>Work on the Micrometer Observability would not be possible without the extensive support of the whole Spring team, <a href="https://github.com/ttddyy/">Tadaya Tsuyukubo</a>, <a href="https://github.com/izeye">Johnny Lim</a>, and all the other contributors and reviewers.</p>
</div>
<h1 id="_next_steps" class="sect0">Next Steps</h1>
<div class="paragraph">
<p>Based on community feedback, we will continue to improve our Observability story. We intend to go <a href="https://github.com/micrometer-metrics/micrometer/milestone/177">GA in November this year</a>.</p>
</div>
<div class="paragraph">
<p>This is an exciting time for us. We would again like to thank everyone who has already contributed and reported feedback, and we look forward to further feedback! Check out Spring Boot&#8217;s latest snapshots! Check out the documentation of our projects: <a href="https://micrometer.io/docs/contextPropagation">Micrometer Context Propagation</a>, <a href="https://micrometer.io/docs">Micrometer</a>, <a href="https://micrometer.io/docs/observation">Micrometer Observation</a>, <a href="https://micrometer.io/docs/tracing">Micrometer Tracing</a> and <a href="https://micrometer.io/docs/observation#_documentation_building">Micrometer Docs Generator</a>! Click <a href="https://github.com/marcingrzejszczak/observability-boot-blog-post">here</a> to see the code used for this blog post.</p>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-10-24 15:28:07 +0700
</div>
</div>
<script>
;(function () { /*! Asciidoctor Tabs | Copyright (c) 2018-present Dan Allen | MIT License */
  'use strict'

  var config = (document.currentScript || {}).dataset || {}
  var forEach = Array.prototype.forEach

  init(document.querySelectorAll('.tabs'))

  function init (tabsBlocks) {
    if (!tabsBlocks.length) return
    forEach.call(tabsBlocks, function (tabs) {
      var syncIds = tabs.classList.contains('is-sync') ? {} : undefined
      var tablist = tabs.querySelector('.tablist ul')
      tablist.setAttribute('role', 'tablist')
      var start
      forEach.call(tablist.querySelectorAll('li'), function (tab, idx) {
        tab.tabIndex = -1
        tab.setAttribute('role', tab.classList.add('tab') || 'tab')
        var id, anchor, syncId
        if (!(id = tab.id) && (anchor = tab.querySelector('a[id]'))) {
          id = tab.id = anchor.parentNode.removeChild(anchor).id
        }
        var panel = id && tabs.querySelector('.tabpanel[aria-labelledby~="' + id + '"]')
        if (!panel) return idx ? undefined : toggleSelected(tab, true) // invalid state
        syncIds && (((syncId = tab.textContent.trim()) in syncIds) ? (syncId = undefined) : true) &&
        (syncIds[(tab.dataset.syncId = syncId)] = tab)
        idx || (syncIds && (start = { tab: tab, panel: panel })) ? toggleHidden(panel, true) : toggleSelected(tab, true)
        tab.setAttribute('aria-controls', panel.id)
        panel.setAttribute('role', 'tabpanel')
        var onClick = syncId === undefined ? activateTab : activateTabSync
        tab.addEventListener('click', onClick.bind({ tabs: tabs, tab: tab, panel: panel }))
      })
      if (!tabs.closest('.tabpanel')) {
        forEach.call(tabs.querySelectorAll('.tabpanel table.tableblock'), function (table) {
          var container = Object.assign(document.createElement('div'), { className: 'tablecontainer' })
          table.parentNode.insertBefore(container, table).appendChild(table)
        })
      }
      if (start) {
        var syncGroupId
        for (var i = 0, lst = tabs.classList, len = lst.length, className; i !== len; i++) {
          if (!(className = lst.item(i)).startsWith('data-sync-group-id=')) continue
          tabs.dataset.syncGroupId = syncGroupId = lst.remove(className) || className.slice(19).replace(/\u00a0/g, ' ')
          break
        }
        if (syncGroupId === undefined) tabs.dataset.syncGroupId = syncGroupId = Object.keys(syncIds).sort().join('|')
        var preferredSyncId = 'syncStorageKey' in config &&
          window[(config.syncStorageScope || 'local') + 'Storage'].getItem(config.syncStorageKey + '-' + syncGroupId)
        var tab = preferredSyncId && syncIds[preferredSyncId]
        tab && Object.assign(start, { tab: tab, panel: document.getElementById(tab.getAttribute('aria-controls')) })
        toggleSelected(start.tab, true) || toggleHidden(start.panel, false)
      }
    })
    onHashChange()
    toggleClassOnEach(tabsBlocks, 'is-loading', 'remove')
    window.setTimeout(toggleClassOnEach.bind(null, tabsBlocks, 'is-loaded', 'add'), 0)
    window.addEventListener('hashchange', onHashChange)
  }

  function activateTab (e) {
    var tab = this.tab
    var tabs = this.tabs || (this.tabs = tab.closest('.tabs'))
    var panel = this.panel || (this.panel = document.getElementById(tab.getAttribute('aria-controls')))
    querySelectorWithSiblings(tabs, '.tablist .tab', 'tab').forEach(function (el) {
      toggleSelected(el, el === tab)
    })
    querySelectorWithSiblings(tabs, '.tabpanel', 'tabpanel').forEach(function (el) {
      toggleHidden(el, el !== panel)
    })
    if (!this.isSync && 'syncStorageKey' in config && 'syncGroupId' in tabs.dataset) {
      var storageKey = config.syncStorageKey + '-' + tabs.dataset.syncGroupId
      window[(config.syncStorageScope || 'local') + 'Storage'].setItem(storageKey, tab.dataset.syncId)
    }
    if (!e) return
    var loc = window.location
    var hashIdx = loc.hash ? loc.href.indexOf('#') : -1
    if (~hashIdx) window.history.replaceState(null, '', loc.href.slice(0, hashIdx))
    e.preventDefault()
  }

  function activateTabSync (e) {
    activateTab.call(this, e)
    var thisTabs = this.tabs
    var thisTab = this.tab
    var initialY = thisTabs.getBoundingClientRect().y
    forEach.call(document.querySelectorAll('.tabs'), function (tabs) {
      if (tabs === thisTabs || tabs.dataset.syncGroupId !== thisTabs.dataset.syncGroupId) return
      querySelectorWithSiblings(tabs, '.tablist .tab', 'tab').forEach(function (tab) {
        if (tab.dataset.syncId === thisTab.dataset.syncId) activateTab.call({ tabs: tabs, tab: tab, isSync: true })
      })
    })
    var shiftedBy = thisTabs.getBoundingClientRect().y - initialY
    if (shiftedBy && (shiftedBy = Math.round(shiftedBy))) window.scrollBy({ top: shiftedBy, behavior: 'instant' })
  }

  function querySelectorWithSiblings (scope, selector, siblingClass) {
    var el = scope.querySelector(selector)
    if (!el) return []
    var result = [el]
    while ((el = el.nextElementSibling) && el.classList.contains(siblingClass)) result.push(el)
    return result
  }

  function toggleClassOnEach (elements, className, method) {
    forEach.call(elements, function (el) {
      el.classList[method](className)
    })
  }

  function toggleHidden (el, state) {
    el.classList[(el.hidden = state) ? 'add' : 'remove']('is-hidden')
  }

  function toggleSelected (el, state) {
    el.setAttribute('aria-selected', '' + state)
    el.classList[state ? 'add' : 'remove']('is-selected')
    el.tabIndex = state ? 0 : -1
  }

  function onHashChange () {
    var id = window.location.hash.slice(1)
    if (!id) return
    var tab = document.getElementById(~id.indexOf('%') ? decodeURIComponent(id) : id)
    if (!(tab && tab.classList.contains('tab'))) return
    'syncId' in tab.dataset ? activateTabSync.call({ tab: tab }) : activateTab.call({ tab: tab })
  }
})()
</script>
</body>
</html>